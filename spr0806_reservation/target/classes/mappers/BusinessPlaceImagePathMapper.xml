<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.reservation.dao.BusinessPlaceImagePathDao">




<!-- 메인이미지인거select, 아닌거selectAll 해서 서비스에서 두개 합쳐서 넘기기  -->
<!-- 메인이미지 아닌거 모두 조회 -->
<select id="selectAllNotMainImage" resultType="com.reservation.dto.BusinessPlaceImagePathDto">
    select * 
    from business_place_image_path
    where email = #{email}
    and business_regi_num = #{business_regi_num}
    and is_main = 'N'
</select>

<!-- 0906 특정벤더의 모든 메인 이미지를 메인이미지가 아니게 변경 -->
<update id="updateIsMainYToN">
    update business_place_image_path
    set is_main = 'N'
    where email = #{email}
    and business_regi_num = #{business_regi_num}
    and is_main = 'Y'
</update>

<!-- 0906 특정벤더의 특정파일을 메인이미지로 변경 -->
<update id="setMainImage">
  UPDATE business_place_image_path
    SET is_main = 'Y'
    WHERE email = #{email}
    AND business_regi_num = #{business_regi_num}
    AND place_img_path = #{place_img_path}
</update>

<!-- 0906 특정 벤더 특정 이미지 삭제 -->
<delete id="deleteImage">
    delete from business_place_image_path
    where place_img_path = #{place_img_path}
</delete>

<!-- 0906 특정 벤더에게 대표 이미지가 있는지 확인 result type int -->
<select id="countMainImage" resultType="int">
    select count(*)
    from business_place_image_path
    where email = #{email}
    and business_regi_num = #{business_regi_num}
    and is_main = 'Y'
</select>

<select id="selectMainImage" resultType="com.reservation.dto.BusinessPlaceImagePathDto">
    select * 
    from business_place_image_path
    where email = #{email}
    and business_regi_num = #{business_regi_num}
    and is_main = 'Y'
</select>

<!-- 0906 남아 있는 첫 번째 이미지를 대표 이미지로 설정 
	서브쿼리 = 특정벤더의 place_img_path를 조회하는데 첫행의 place_img_path값을 반환
	fetch first 1 rows only = 결과에서 첫 행만 가져옴
	외부쿼리 = 해당 place_img_path의  is_main을 Y로 바꾼다
-->
<update id="setFirstImageAsMain">
    update business_place_image_path
    set is_main = 'Y'
    where email = #{email}
    and business_regi_num = #{business_regi_num}
    and place_img_path = (
        select place_img_path
        from business_place_image_path
        where email = #{email}
        and business_regi_num = #{business_regi_num}
        fetch first 1 rows only
    )
</update>












<insert id="insertMyBusinessPlaceImagePath">
    insert into business_place_image_path (
    	email, business_regi_num, place_img_path,file_data
    ) values (
        #{email}, #{business_regi_num}, #{place_img_path},#{file_data}
    )
</insert>
<!-- #{img_path0, jdbcType=VARCHAR}  jdbcType=VARCHAR  NULL 허용 한다는 뜻   -->

<select id="selectAllMyBusinessPlaceImgPaths" resultType="com.reservation.dto.BusinessPlaceImagePathDto">
select *
    from business_place_image_path 
    where email=#{email} and business_regi_num=#{business_regi_num}
</select>
<select id="selectImage" resultType="com.reservation.dto.BusinessPlaceImagePathDto">

select *
    from business_place_image_path 
    where place_img_path=#{place_img_path} 
</select>

   


</mapper>